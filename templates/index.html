<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f7f8fa;
            margin: 40px;
        }

        h1 {
            text-align: center;
        }

        .nav {
            text-align: center;
            margin-bottom: 30px;
        }

        .nav a {
            text-decoration: none;
            color: white;
            background-color: #333;
            padding: 10px 16px;
            border-radius: 5px;
            margin: 0 5px;
        }

        .nav a:hover {
            background-color: #555;
        }

        .controls {
            text-align: center;
            margin-bottom: 20px;
        }

        select,
        button {
            padding: 8px 12px;
            font-size: 1em;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #333;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #333;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .message {
            text-align: center;
            font-size: 1.2em;
            color: #888;
            margin-top: 40px;
        }

        .day-header {
            text-align: center;
            font-size: 1.3em;
            margin-top: 20px;
            color: #333;
            font-weight: bold;
        }

        .edit-controls {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>üèãÔ∏è Gym Planner</h1>

    <div class="nav">
        <a href="/">üè† Today‚Äôs Plan</a>
        <a href="/exercises">üìò Exercise Library</a>
        <a href="/selected">‚≠ê Selected Exercises</a>
    </div>

    <div class="controls">
        <form method="POST">
            <label for="date">Select a date:</label>
            <select name="date" id="date">
                {% for d in dates %}
                <option value="{{ d }}" {% if d==selected_date %}selected{% endif %}>{{ d }}</option>
                {% endfor %}
            </select>
            <button type="submit">View Plan</button>
        </form>
    </div>

    {% if plan %}
    <div class="day-header">{{ workout_type }} ‚Äî {{ selected_date }}</div>

    <!-- Edit and Save buttons -->
    <div class="edit-controls">
        <button id="editBtn">üìù Edit Plan</button>
        <button id="saveBtn" style="display:none;">üíæ Save Changes</button>
    </div>

    <table id="planTable">
        <thead>
            <tr>
                <th>Exercise</th>
                <th>Sets</th>
                <th>Reps</th>
                <th>Weight</th>
                <th>Muscle Group</th>
            </tr>
        </thead>
        <tbody>
            {% for item in plan %}
            <tr>
                <td>{{ item['Exercise'] }}</td>
                <td>{{ item['Sets'] }}</td>
                <td>{{ item['Reps'] }}</td>
                <td>{{ item['Weight'] }}</td>
                <td>{{ item['Primary Muscle Group'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const table = document.getElementById('planTable');
        const date = "{{ selected_date }}";
        const workoutType = "{{ workout_type }}";  // ‚úÖ Capture workout type

        let editing = false;

        // üìù Enable editing
        editBtn.addEventListener('click', () => {
            editing = true;
            saveBtn.style.display = 'inline-block';
            editBtn.style.display = 'none';

            // Make table cells editable except Exercise & Muscle Group
            table.querySelectorAll('tbody tr').forEach(row => {
                const editableCells = row.querySelectorAll('td:nth-child(2), td:nth-child(3), td:nth-child(4)');
                editableCells.forEach(td => td.contentEditable = true);
            });
        });

        // üíæ Save edits back to server
        saveBtn.addEventListener('click', async () => {
            const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    Exercise: cells[0].textContent.trim(),
                    Sets: cells[1].textContent.trim(),
                    Reps: cells[2].textContent.trim(),
                    Weight: cells[3].textContent.trim(),
                    PrimaryMuscleGroup: cells[4].textContent.trim()
                };
            });

            const res = await fetch('/save_plan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: date,
                    plan: rows,
                    workout_type: workoutType
                })
            });

            const result = await res.json();
            alert(result.message);

            // Disable editing again
            table.querySelectorAll('td[contenteditable="true"]').forEach(td => td.contentEditable = false);
            editBtn.style.display = 'inline-block';
            saveBtn.style.display = 'none';
            editing = false;
        });
    </script>


    {% else %}
    <div class="message">{{ message }}</div>
    {% endif %}
</body>

</html>