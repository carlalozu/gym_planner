{% extends "base.html" %}
{% block title %}Index{% endblock %}

{% block content %}

<div class="controls">
    <form method="POST">
        <label for="date">Select a date:</label>
        <input type="date" name="date" id="date" value="{{ selected_date }}" min="{{ dates[0] }}" max="{{ dates[-1] }}">
        <button type="submit">View Plan</button>
    </form>
</div>

{% if plan %}
<div class="day-header">{{ workout_type }} â€” {{ selected_date }}</div>

<table id="planTable">
    <thead>
        <tr>
            <th>Exercise</th>
            <th>Sets</th>
            <th>Reps</th>
            <th>Weight</th>
            <th>Muscle Group</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        {% for item in plan %}
        <tr>
            <td>{{ item['Exercise'] }}</td>
            <td>{{ item['Sets'] }}</td>
            <td>{{ item['Reps'] }}</td>
            <td>{{ item['Weight'] }}</td>
            <td>{{ item['Muscle Group'] }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Edit and Save buttons -->
<div class="edit-controls">
    <button id="editBtn">ğŸ“ Edit Plan</button>
    <button id="saveBtn" style="display:none;">ğŸ’¾ Save Changes</button>
    <button id="cancelBtn" style="display:none;">âŒ Cancel</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const table = document.getElementById('planTable');
    const cancelBtn = document.getElementById('cancelBtn');
    const date = "{{ selected_date }}";
    const workoutType = "{{ workout_type }}"

    let editing = false;

    // Enable editing
    let sortableInstance = null;

    editBtn.addEventListener('click', () => {
        editing = true;
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        editBtn.style.display = 'none';

        // Make table cells editable except Exercise & Muscle Group
        table.querySelectorAll('tbody tr').forEach(row => {
            const editableCells = row.querySelectorAll('td:nth-child(2), td:nth-child(3), td:nth-child(4)');
            editableCells.forEach(td => td.contentEditable = true);
        });

        // --- Enable drag-to-sort rows ---
        const tbody = document.getElementById('tableBody');

        sortableInstance = Sortable.create(tbody, {
            animation: 150,
            handle: 'td',          // drag from any cell
            ghostClass: 'dragging' // optional styling
        });
    });

    function disableSorting() {
        if (sortableInstance) {
            sortableInstance.destroy();
            sortableInstance = null;
        }
    }

    // Add cancel button
    cancelBtn.addEventListener('click', () => {
        disableSorting();
        if (editing) {
            // Reload the page to discard changes
            location.reload();
        }
    });

    // Save edits back to server
    saveBtn.addEventListener('click', async () => {
        disableSorting();
        const rows = Array.from(table.querySelectorAll('tbody tr')).map(row => {
            const cells = row.querySelectorAll('td');
            return {
                Exercise: cells[0].textContent.trim(),
                Sets: cells[1].textContent.trim(),
                Reps: cells[2].textContent.trim(),
                Weight: cells[3].textContent.trim(),
                PrimaryMuscleGroup: cells[4].textContent.trim()
            };
        });

        const res = await fetch('/save_plan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: date,
                plan: rows,
                workout_type: workoutType
            })
        });

        const result = await res.json();
        alert(result.message);

        // Disable editing again
        table.querySelectorAll('td[contenteditable="true"]').forEach(td => td.contentEditable = false);
        editBtn.style.display = 'inline-block';
        saveBtn.style.display = 'none';
        editing = false;
    });
</script>


{% else %}
<div class="message">{{ message }}</div>
{% endif %}

{% endblock %}